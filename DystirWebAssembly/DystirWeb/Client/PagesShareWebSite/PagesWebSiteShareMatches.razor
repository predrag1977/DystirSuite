@page "/{page}/matches"

@layout PagesWebSiteShareLayout
@implements IDisposable

<link href="css/@(page)_style.css?v=105" rel="stylesheet" />

@if (page.Equals("dimma", StringComparison.CurrentCultureIgnoreCase) || page.Equals("info", StringComparison.CurrentCultureIgnoreCase))
{
    <div class="matches_and_competition_selection">
        @if (CompetitionsList?.Count > 0)
        {
            <div id="competitions_selection">
                <ChooseCompetitions CompetitionsList="@(CompetitionsList)"
                                    SelectedCompetition="@(SelectedCompetition)"
                                    CompetitionsOnClick="@(CompetitionsOnClick)" />
            </div>
            <div id="matches_same_day_share">
                @foreach (var matchesGroup in SelectedMatchListGroup ?? new List<IGrouping<string, Matches>>())
                    {
                        if (SelectedCompetition == matchesGroup.Key)
                        {
                            var matches = matchesGroup.Select(x => x);
                        @foreach (Matches match in matches)
                            {
                            <NavLink style="cursor:pointer;" target="_new" href="@(page + "/matchdetails/" + match.MatchID)">
                                <PagesWebSiteShareMatch MatchItem="@match"
                                                        TimeZoneOffset="@timeZoneOffset"
                                                        IsMatchForSameDayList="@true"
                                                        NumberOfMatches="@numberOfMatches"
                                                        Page="@(page)"/>
                            </NavLink>
                            }
                        }
                    }
            </div>
        }
        else if (CompetitionsList?.Count == 0)
        {
            <div class="no-matches">Eingin dystur í dag</div>
        }
        @if (isLoading)
        {
            <div class="loading-spinner-parent">
                <i class="fas fa-spin fa-spinner fa-2x" style="color: darkgrey"></i>
            </div>
        }
    </div>
}
else if (page.Equals("portal", StringComparison.CurrentCultureIgnoreCase))
{
<div class="matches_and_competition_selection">
    @if (CompetitionsList?.Count > 0)
    {

        if (SelectedPage == "DYSTIR Í DAG")
        {
            <div id="competitions_selection">
                <ChooseCompetitions CompetitionsList="@(CompetitionsList)"
                                    SelectedCompetition="@(SelectedCompetition)"
                                    CompetitionsOnClick="@(CompetitionsOnClick)" />
            </div>

            <div id="main_container_vertical_list">
                <div id="matches_same_day_share">
                    @foreach (var matchesGroup in SelectedMatchListGroup ?? new List<IGrouping<string, Matches>>())
                    {
                        if (SelectedCompetition == matchesGroup.Key)
                        {
                            var matches = matchesGroup.Select(x => x);
                            @foreach (Matches match in matches)
                            {
                                <div>
                                    <NavLink style="cursor:pointer;" target="_new" href="@(page + "/matchdetails/" + match.MatchID)">
                                        <PagesWebSiteShareMatch MatchItem="@match"
                                                                TimeZoneOffset="@timeZoneOffset"
                                                                IsMatchForSameDayList="@true"
                                                                NumberOfMatches="@numberOfMatches"
                                                                Page="@(page)">
                                        </PagesWebSiteShareMatch>
                                    </NavLink>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        }
        else if (SelectedPage == "STØÐAN")
        {
            <div id="competitions_selection">
                <ChooseCompetitions CompetitionsList="@(StandingsCompetitionsList)"
                                    SelectedCompetition="@(SelectedStandingsCompetition)"
                                    CompetitionsOnClick="@(CompetitionsOnClick)" />
            </div>
            <div id="main_container_vertical_list">
                <LiveStandingView Standing="@(standing)" />
            </div>
        }

        <div id="competitions_selection">
            <ChoosePages PagesList="@(PagesList)"
                         SelectedPage="@(SelectedPage)"
                         PagesOnClick="@(PagesOnClick)" />
        </div>

    }
    else if (CompetitionsList?.Count == 0)
    {
        <div class="no-matches">Eingin dystur í dag</div>
    }

    @if (isLoading)
    {
        <div class="loading-spinner-parent">
            <i class="fas fa-spin fa-spinner fa-2x" style="color: darkgrey"></i>
        </div>
    }
</div>
}
    

@code {
    [Parameter]
    public string page { get; set; }

    private string SelectedCompetition { get; set; }
    private List<string> CompetitionsList { get; set; }
    private string SelectedStandingsCompetition { get; set; }
    private List<string> StandingsCompetitionsList { get; set; }
    private string SelectedPage { get; set; }
    private List<string> PagesList { get; set; }
    private List<IGrouping<string, Matches>> SelectedMatchListGroup;
    private int timeZoneOffset = 0;
    private bool isLoading = true;
    private int numberOfMatches = 0;
    private Standing standing;

    protected override async Task OnInitializedAsync()
    {
        DystirWebClientService.OnFullDataLoaded += DystirWebClientService_FullDataLoaded;
        DystirWebClientService.OnConnected += HubConnection_OnConnected;
        DystirWebClientService.OnRefreshMatchDetails += DystirWebClientService_OnRefreshMatchDetails;
        TimeService.OnTimerElapsed += TimerElapsed;
        timeZoneOffset = int.Parse(await JSRuntime.InvokeAsync<String>("getTimeZoneOffset"));
        await GetSelectedMatchListGroup();
    }

    void IDisposable.Dispose()
    {
        DystirWebClientService.OnFullDataLoaded -= DystirWebClientService_FullDataLoaded;
        DystirWebClientService.OnConnected -= HubConnection_OnConnected;
        DystirWebClientService.OnRefreshMatchDetails -= DystirWebClientService_OnRefreshMatchDetails;
        TimeService.OnTimerElapsed -= TimerElapsed;
    }

    private async void DystirWebClientService_FullDataLoaded()
    {
        await GetSelectedMatchListGroup();
    }

    private async void HubConnection_OnConnected()
    {
        await GetSelectedMatchListGroup();
    }

    private async void DystirWebClientService_OnRefreshMatchDetails(MatchDetails matchDetails)
    {
        await GetSelectedMatchListGroup();
    }

    private void TimerElapsed(object sender, EventArgs e)
    {
        if (HubConnection.State == HubConnectionState.Connected)
        {
            Refresh();
        }
    }

    private void Refresh()
    {
        InvokeAsync(() => StateHasChanged());
    }

    private void CompetitionsOnClick(string competition)
    {
        if(SelectedPage == "DYSTIR Í DAG")
        {
            SelectedCompetition = competition;
        }
        else if (SelectedPage == "STØÐAN")
        {
            SelectedStandingsCompetition = competition;
        }

        numberOfMatches = SelectedMatchListGroup.FirstOrDefault(x => x.Key == SelectedCompetition)?.Select(x => x)?.Count() ?? 0;
        standing = LiveStandingService.GetStanding(SelectedStandingsCompetition);
        Refresh();
    }

    private void PagesOnClick(string page)
    {
        SelectedPage = page;
        Refresh();
    }

    public async Task GetSelectedMatchListGroup()
    {
        var fromDate = DateTime.UtcNow.AddMinutes(-timeZoneOffset).Date.AddDays(0);
        var toDate = fromDate.AddDays(0);
        SelectedMatchListGroup = DystirWebClientService.AllMatches?
            .OrderBy(x => x.MatchTypeID).ThenBy(x => x.Time).ThenBy(x => x.MatchID)
            .Where(x => x.Time.Value.AddMinutes(-timeZoneOffset).Date >= fromDate && x.Time.Value.AddMinutes(-timeZoneOffset).Date <= toDate)
            .GroupBy(x => x.MatchTypeName)?.ToList();

        if (SelectedMatchListGroup == null) return;

        CompetitionsList = new List<string>();
        foreach (var matchGroup in SelectedMatchListGroup ?? new List<IGrouping<string, Matches>>())
        {
            CompetitionsList.Add(matchGroup.Key);
        }
        StandingsCompetitionsList = DystirWebClientService.AllCompetitions
                .Where(x => x.CompetitionID > 0)
                .OrderBy(x => x.OrderID)?
                .Select(x => x.MatchTypeName)?
                .ToList() ?? new List<string>();

        SetPagesMenu();
        SelectedCompetition = string.IsNullOrWhiteSpace(SelectedCompetition) ? CompetitionsList?.FirstOrDefault() ?? "" : SelectedCompetition;
        SelectedStandingsCompetition = string.IsNullOrWhiteSpace(SelectedStandingsCompetition) ? StandingsCompetitionsList?.FirstOrDefault() ?? "" : SelectedStandingsCompetition;

        numberOfMatches = SelectedMatchListGroup?.FirstOrDefault(x => x.Key == SelectedCompetition)?.Select(x => x)?.Count() ?? 0;
        standing = LiveStandingService.GetStanding(SelectedCompetition);
        isLoading = false;
        Refresh();
        await JSRuntime.InvokeVoidAsync("onPageResize", "");
    }


    private void SetPagesMenu()
    {
        PagesList = new List<string>();
        if (CompetitionsList.Count != 0)
        {
            PagesList.Add("DYSTIR Í DAG");
        }
        PagesList.Add("STØÐAN");
        SelectedPage = string.IsNullOrWhiteSpace(SelectedPage) ? PagesList?.FirstOrDefault() ?? "" : SelectedPage;
    }
}
